name: flutter_modular_clean_demo
description: "flutter_modular_clean_demo"
workspace:
  - packages/infrastructure/network
  - packages/infrastructure/event_bus
  - packages/infrastructure/storage

  - packages/features/home
  - packages/features/profile
  - packages/features/auth
  - packages/features/app_shell

  - packages/shared/analytics
  - packages/shared/assets
  - packages/shared/config
  - packages/shared/core
  - packages/shared/session
  - packages/shared/design_system
  - packages/shared/theming

  - app/root

environment:
  sdk: ^3.9.2

dev_dependencies:
  melos: ^7.1.1

melos:
  categories:
    features:
      - packages/features/*
    infrastructure:
      - packages/infrastructure/*
    shared:
      - packages/shared/*
  command:
    bootstrap:
      # It seems so that running "pub get" in parallel has some issues (like
      # https://github.com/dart-lang/pub/issues/3404). Disabling this feature
      # makes the CI much more stable.
      runPubGetInParallel: false
  scripts:
    # Clean build_runner cache
    codegen:clean:
      run: |
        melos exec --concurrency=1 --ignore="design_system" -- \
          "dart run build_runner clean"
      description: "Clean build_runner cache for all packages (excluding design_system)"
    # --concurrency=1: Run sequentially to reduce peak memory usage (avoid OOM) and
    # minimize IO contention / occasional race conditions in CI or Windows.
    # --ignore="design_system": Explicitly skip this package to avoid scanning/executing
    # codegen there (and to prevent accidental inclusion if its dependencies change later).
    # Step 1: Process child packages first (exclude root and design_system, using inline filters to ensure only packages with build_runner run) to generate base modules
    # Step 2: After those finish, run root explicitly (no filters) to aggregate the results
    # Adding --concurrency=1 helps avoid file lock issues on Windows
    codegen:
      run: >
        melos exec --concurrency=1 --ignore="root,design_system" --depends-on="build_runner" --fail-fast -- "dart run build_runner build --delete-conflicting-outputs" &&
        melos exec --concurrency=1 --scope="root" -- "dart run build_runner build --delete-conflicting-outputs"
      description: Run code generation for all packages.
    codegen:watch:
      run: |
        melos exec --fail-fast -- \
          "dart run build_runner watch --delete-conflicting-outputs"
      description: Run code generation in watch mode for all packages.
      packageFilters:
        dependsOn:
          - build_runner
        dirExists:
          - lib
    # Clear build_runner cache first, then run code generation
    codegen:reset:
      run: |
        melos run codegen:clean && melos run codegen
      description: "Reset project: clean build_runner cache and run full code generation"
    # Full project deep reset (including dependency sync and Codegen)
    project:reset:
      run: |
        melos bootstrap && melos run codegen:reset
      description: "Full project reset: Bootstrap dependencies and rebuild all generated code."
    codegen:all:
      run: melos run codegen --no-select
      description: Run code generation for all packages with no selection.
    add:devs:
      run: melos run dev_dependencies && melos bs

      # dev_dependencies:
      #   run: |
      #     melos exec --category="features" --fail-fast -- \
      #       "flutter pub add -d build_runner freezed json_serializable injectable_generator auto_route_generator"
      #   description: Run `flutter pub get` for all packages.\
      # Install common code generation tools for feature packages
      setup:feature-deps:
        run: |
          melos exec --category="features" --fail-fast -- \
            "flutter pub add -d build_runner freezed json_serializable injectable_generator auto_route_generator"
        description: "Install common code generation dependencies to all feature packages."
      # Combined command: automatically bootstrap and link packages after installation
      project:init-features:
        run: |
          melos run setup:feature-deps && melos bs
        description: "One-stop setup for feature packages and bootstrap."

    test:
      run: |
        melos exec --fail-fast -- \
          "flutter test"
      description: Run `flutter test` for a specific package.
      packageFilters:
        dirExists:
          - test
        ignore:
          - '*example*'